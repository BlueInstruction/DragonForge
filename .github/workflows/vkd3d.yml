name: VKD3D

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      FORCE_MODE:
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  core_build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Cache llvm-mingw
        uses: actions/cache@v4
        id: cache-llvm
        with:
          path: llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64
          key: llvm-mingw-20241217

      - name: SYNC_DEPS
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y git meson ninja-build curl jq gh python3-venv glslang-tools zstd

      - name: Setup llvm-mingw
        run: |
          set -e
          if [[ ! -d "llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64" ]]; then
            curl -L -o llvm-mingw.tar.xz "https://github.com/mstorsjo/llvm-mingw/releases/download/20241217/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64.tar.xz"
            tar -xf llvm-mingw.tar.xz
            rm -f llvm-mingw.tar.xz
          fi
          echo "$PWD/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

      - name: FETCH_TAG
        id: info
        run: |
          set -e
          LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r .tag_name)
          if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch latest tag"
            exit 1
          fi
          
          REF_DATA=$(curl -s "https://api.github.com/repos/HansKristian-Work/vkd3d-proton/git/refs/tags/$LATEST_TAG")
          OBJ_TYPE=$(echo "$REF_DATA" | jq -r '.object.type')
          OBJ_SHA=$(echo "$REF_DATA" | jq -r '.object.sha')
          
          if [[ "$OBJ_TYPE" == "tag" ]]; then
            OBJ_SHA=$(curl -s "https://api.github.com/repos/HansKristian-Work/vkd3d-proton/git/tags/$OBJ_SHA" | jq -r '.object.sha')
          fi
          COMMIT_SHORT="${OBJ_SHA:0:7}"
          
          echo "TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "VER=${LATEST_TAG#v}" >> $GITHUB_ENV
          echo "COMMIT=$COMMIT_SHORT" >> $GITHUB_ENV

      - name: CHECK_EXISTENCE
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          EXISTS=$(gh release view "build-${{ env.VER }}" --repo ${{ github.repository }} > /dev/null 2>&1 && echo "true" || echo "false")
          if [[ "${{ inputs.FORCE_MODE }}" == "true" ]]; then EXISTS="false"; fi
          echo "SKIP_RUN=$EXISTS" >> $GITHUB_OUTPUT

      - name: COMPILE_SRC
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          set -e
          git clone --recursive --branch ${{ env.TAG }} https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          ./package-release.sh ${{ env.TAG }} ../out --no-package

      - name: VERIFY_BUILD
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          set -e
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*")
          
          if [[ -z "$SRC_PATH" ]]; then
            echo "ERROR: Build output directory not found"
            exit 1
          fi
          
          echo "=== Checking required DLLs ==="
          MISSING=0
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              if [[ ! -f "$SRC_PATH/$arch/$dll" ]]; then
                echo "ERROR: Missing $arch/$dll"
                MISSING=1
              fi
            done
          done
          
          if [[ $MISSING -eq 1 ]]; then
            echo "ERROR: Build incomplete - missing DLLs"
            exit 1
          fi
          
          echo "=== DLL Sizes ==="
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              echo "$arch/$dll: $(du -h "$SRC_PATH/$arch/$dll" | cut -f1)"
            done
          done
          
          for arch in x64 x86; do
            SIZE=$(stat -c%s "$SRC_PATH/$arch/d3d12core.dll")
            if [[ $SIZE -lt 4000000 ]]; then
              echo "ERROR: $arch/d3d12core.dll is too small ($SIZE bytes)"
              exit 1
            fi
          done
          
          echo "=== Build verification passed ==="

      - name: PREP_WCP_ROOT
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          set -e
          mkdir -p staging/system32 staging/syswow64
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*")
          
          # Copy DLLs
          cp "$SRC_PATH/x64/"*.dll staging/system32/
          cp "$SRC_PATH/x86/"*.dll staging/syswow64/
          
          # Strip symbols
          if command -v llvm-strip &> /dev/null; then
            find staging -iname '*.dll' -exec llvm-strip --strip-all {} \;
          fi
          
          # Generate file lists
          FILES_64=$(find staging/system32 -maxdepth 1 -type f -iname "*.dll" -printf '%f\n' | sort)
          FILES_32=$(find staging/syswow64 -maxdepth 1 -type f -iname "*.dll" -printf '%f\n' | sort)
          
          # Build files array using jq
          FILES_JSON=$(echo "$FILES_64" | jq -R -s 'split("\n") | map(select(length > 0)) | map({source: ("system32/" + .), target: ("${system32}/" + .)})' )
          FILES_JSON=$(echo "$FILES_32" | jq -R -s --argjson existing "$FILES_JSON" 'split("\n") | map(select(length > 0)) | map({source: ("syswow64/" + .), target: ("${syswow64}/" + .)}) | $existing + .')
          
          # Create profile.json
          jq -n \
            --arg TYPE "VKD3D" \
            --arg VER "${{ env.VER }}" \
            --argjson VC 0 \
            --arg DESC "VKD3D-Proton ${{ env.VER }} (Upstream: Hans-Kristian Arntzen)" \
            --argjson FILES "$FILES_JSON" \
            '{
              type: $TYPE,
              versionName: $VER,
              versionCode: $VC,
              description: $DESC,
              files: $FILES
            }' > staging/profile.json
          
          echo "=== profile.json ==="
          cat staging/profile.json

      - name: PACK_WCP
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          set -e
          cd staging
          tar --zstd \
            --format=gnu \
            --owner=0 \
            --group=0 \
            --numeric-owner \
            --sort=name \
            -cf "../vkd3d-proton-${{ env.VER }}.wcp" \
            profile.json system32 syswow64
          
          echo "WCP_FILE=vkd3d-proton-${{ env.VER }}.wcp" >> $GITHUB_ENV
          
          echo "=== WCP Contents ==="
          tar --zstd -tvf "../vkd3d-proton-${{ env.VER }}.wcp"

      - name: DEPLOY_RELEASE
        if: steps.check.outputs.SKIP_RUN == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ env.VER }}
          name: VKD3D-Proton ${{ env.VER }}
          files: ${{ env.WCP_FILE }}
          body: |
            ## VKD3D-Proton ${{ env.VER }}
            
            - Architecture: x64 (system32) + x86 (syswow64)
            - **Commit:** `${{ env.COMMIT }}`
            - **Source:** [HansKristian-Work/vkd3d-proton](https://github.com/HansKristian-Work/vkd3d-proton/releases/tag/${{ env.TAG }})
