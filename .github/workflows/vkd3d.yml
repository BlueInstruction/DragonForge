name: VKD3D-Proton

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      FORCE_MODE:
        type: boolean
        default: false
      VERSION:
        description: "Specific version to build (leave empty for latest)"
        required: false
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  build_ue5_patch:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            meson \
            ninja-build \
            curl \
            jq \
            python3-venv \
            glslang-tools \
            zstd \
            llvm \
            gcc-mingw-w64-x86-64 \
            gcc-mingw-w64-i686 \
            g++-mingw-w64-x86-64 \
            g++-mingw-w64-i686 \
            mingw-w64 \
            mingw-w64-tools

      - name: Fetch Version
        run: |
          if [[ -n "${{ inputs.VERSION }}" ]]; then
            LATEST_TAG="${{ inputs.VERSION }}"
            if [[ ! "$LATEST_TAG" =~ ^v ]]; then
              LATEST_TAG="v$LATEST_TAG"
            fi
          else
            LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r .tag_name)
          fi
          
          if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch version"
            exit 1
          fi
          
          echo "TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "VER=${LATEST_TAG#v}" >> $GITHUB_ENV
          echo "Detected version: $LATEST_TAG"

      - name: Check Release Existence
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTS=$(gh release view "build-${{ env.VER }}" --repo ${{ github.repository }} > /dev/null 2>&1 && echo "true" || echo "false")
          if [[ "${{ inputs.FORCE_MODE }}" == "true" ]]; then EXISTS="false"; fi
          echo "SKIP_RUN=$EXISTS" >> $GITHUB_OUTPUT
          echo "Release exists: $EXISTS"

      - name: Clone Source
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          echo "Cloning vkd3d-proton ${{ env.TAG }}..."
          git clone --recursive --branch ${{ env.TAG }} https://github.com/HansKristian-Work/vkd3d-proton.git src

      - name: Get Commit Hash
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          cd src
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          echo "COMMIT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "Commit: $COMMIT_SHORT"

      - name: Analyze Source Code
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          cd src
          DEVICE_FILE="libs/vkd3d/device.c"
          
          echo "=== Analyzing device.c structure ==="
          echo ""
          echo "Looking for D3D12_FEATURE cases..."
          grep -n "case D3D12_FEATURE_D3D12_OPTIONS1:" "$DEVICE_FILE" || echo "OPTIONS1 not found"
          grep -n "case D3D12_FEATURE_SHADER_MODEL:" "$DEVICE_FILE" || echo "SHADER_MODEL not found"
          grep -n "case D3D12_FEATURE_D3D12_OPTIONS7:" "$DEVICE_FILE" || echo "OPTIONS7 not found"
          
          echo ""
          echo "Looking for data assignments..."
          grep -n "data->WaveOps" "$DEVICE_FILE" || echo "WaveOps not found"
          grep -n "data->HighestShaderModel" "$DEVICE_FILE" || echo "HighestShaderModel not found"
          grep -n "data->MeshShaderTier" "$DEVICE_FILE" || echo "MeshShaderTier not found"
          
          echo ""
          echo "=== OPTIONS1 section ==="
          grep -A30 "case D3D12_FEATURE_D3D12_OPTIONS1:" "$DEVICE_FILE" | head -35
          
          echo ""
          echo "=== SHADER_MODEL section ==="
          grep -A15 "case D3D12_FEATURE_SHADER_MODEL:" "$DEVICE_FILE" | head -20
          
          echo ""
          echo "=== OPTIONS7 section ==="
          grep -A15 "case D3D12_FEATURE_D3D12_OPTIONS7:" "$DEVICE_FILE" | head -20

      - name: Apply UE5 Patch
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          echo "Applying UE5 WaveOps + Shader Model patch..."
          cd src
          
          DEVICE_FILE="libs/vkd3d/device.c"
          
          # Backup
          cp "$DEVICE_FILE" "$DEVICE_FILE.orig"
          
          # Add header
          sed -i '1i\/* UE5.5 Compatibility Patch - Force WaveOps, ShaderModel 6.6, MeshShader */' "$DEVICE_FILE"
          
          # Use Python for reliable patching
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open("libs/vkd3d/device.c", "r") as f:
              content = f.read()
          
          patches_applied = 0
          
          # Patch 1: WaveOps in OPTIONS1
          # Find: data->WaveOps = ... and add override after
          pattern1 = r'(data->WaveOps = [^;]+;)'
          replacement1 = r'''\1
                      /* UE5 Force WaveOps */
                      data->WaveOps = TRUE;
                      data->WaveLaneCountMin = 32;
                      data->WaveLaneCountMax = 64;'''
          
          if re.search(pattern1, content):
              content = re.sub(pattern1, replacement1, content, count=1)
              patches_applied += 1
              print("Patch 1 applied: WaveOps")
          else:
              print("Patch 1 FAILED: WaveOps pattern not found")
          
          # Patch 2: ShaderModel
          # Find: data->HighestShaderModel = ... and add override after
          pattern2 = r'(data->HighestShaderModel = [^;]+;)(\s*\n\s*return S_OK;)'
          replacement2 = r'''\1
                      /* UE5 Force Shader Model 6.6 */
                      if (data->HighestShaderModel < D3D_SHADER_MODEL_6_6)
                          data->HighestShaderModel = D3D_SHADER_MODEL_6_6;\2'''
          
          if re.search(pattern2, content):
              content = re.sub(pattern2, replacement2, content, count=1)
              patches_applied += 1
              print("Patch 2 applied: ShaderModel")
          else:
              # Try alternative pattern
              pattern2_alt = r'(data->HighestShaderModel = [^;]+;)'
              replacement2_alt = r'''\1
                      /* UE5 Force Shader Model 6.6 */
                      if (data->HighestShaderModel < D3D_SHADER_MODEL_6_6)
                          data->HighestShaderModel = D3D_SHADER_MODEL_6_6;'''
              if re.search(pattern2_alt, content):
                  content = re.sub(pattern2_alt, replacement2_alt, content, count=1)
                  patches_applied += 1
                  print("Patch 2 applied: ShaderModel (alt)")
              else:
                  print("Patch 2 FAILED: ShaderModel pattern not found")
          
          # Patch 3: MeshShader in OPTIONS7
          # Find: data->MeshShaderTier = ... and add override after
          pattern3 = r'(data->MeshShaderTier = [^;]+;)'
          replacement3 = r'''\1
                      /* UE5 Force MeshShader Tier 1 */
                      if (data->MeshShaderTier < D3D12_MESH_SHADER_TIER_1)
                          data->MeshShaderTier = D3D12_MESH_SHADER_TIER_1;'''
          
          if re.search(pattern3, content):
              content = re.sub(pattern3, replacement3, content, count=1)
              patches_applied += 1
              print("Patch 3 applied: MeshShader")
          else:
              print("Patch 3 FAILED: MeshShader pattern not found")
          
          with open("libs/vkd3d/device.c", "w") as f:
              f.write(content)
          
          print(f"\nTotal patches applied: {patches_applied}/3")
          PYTHON_SCRIPT
          
          # Verify
          echo ""
          echo "=== Verification ==="
          PATCH_COUNT=$(grep -c "UE5 Force" "$DEVICE_FILE" || echo "0")
          echo "Patch markers found: $PATCH_COUNT"
          
          echo ""
          echo "=== Patched sections ==="
          grep -B1 -A3 "UE5 Force" "$DEVICE_FILE" || echo "No patches found"
          
          if [[ "$PATCH_COUNT" -lt 3 ]]; then
            echo ""
            echo "WARNING: Not all patches applied. Showing diff:"
            diff "$DEVICE_FILE.orig" "$DEVICE_FILE" | head -100 || true
          fi

      - name: Build vkd3d-proton
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          cd src
          ./package-release.sh ${{ env.TAG }} ../out --no-package

      - name: Verify Build
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*")
          if [[ -z "$SRC_PATH" ]]; then
            echo "ERROR: Build output not found"
            exit 1
          fi
          
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              if [[ ! -f "$SRC_PATH/$arch/$dll" ]]; then
                echo "ERROR: Missing $arch/$dll"
                exit 1
              fi
            done
          done
          
          echo "Build verification passed"

      - name: Prepare WCP Package
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          mkdir -p staging/system32 staging/syswow64
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*")
          
          cp "$SRC_PATH/x64/"*.dll staging/system32/
          cp "$SRC_PATH/x86/"*.dll staging/syswow64/
          
          cat > staging/profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "${{ env.VER }}-${{ env.COMMIT }}",
            "versionCode": 0,
            "description": "VKD3D-Proton ${{ env.VER }} UE5 Patch - Force WaveOps, ShaderModel 6.6, MeshShader",
            "files": [
              {
                "source": "system32/d3d12.dll",
                "target": "\${system32}/d3d12.dll"
              },
              {
                "source": "system32/d3d12core.dll",
                "target": "\${system32}/d3d12core.dll"
              },
              {
                "source": "syswow64/d3d12.dll",
                "target": "\${syswow64}/d3d12.dll"
              },
              {
                "source": "syswow64/d3d12core.dll",
                "target": "\${syswow64}/d3d12core.dll"
              }
            ]
          }
          EOF
          
          cd staging
          tar --zstd --format=gnu -cf "../vkd3d-proton-${{ env.VER }}.wcp" profile.json system32 syswow64
          
          echo "Package created: vkd3d-proton-${{ env.VER }}.wcp"

      - name: Deploy Release
        if: steps.check.outputs.SKIP_RUN == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ env.VER }}
          name: VKD3D-Proton ${{ env.VER }} (UE5 Patch)
          files: vkd3d-proton-${{ env.VER }}.wcp
          body: |
            VKD3D-Proton ${{ env.VER }} patched for UE5.5 support on Winlator
            
            Commit: ${{ env.COMMIT }}
            
            Patches applied:
            - Force WaveOps enabled
            - Force Shader Model 6.6
            - Force MeshShader Tier 1
