name: Build Translation Layers

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_vkd3d:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            cross_file: build-win64.txt
            cc: x86_64-w64-mingw32-gcc
            cxx: x86_64-w64-mingw32-g++
          - arch: arm64ec
            cross_file: cross-arm64ec.txt
            cc: arm64ec-w64-mingw32-clang
            cxx: arm64ec-w64-mingw32-clang++
    steps:
      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git ninja-build python3 glslang-tools spirv-tools zstd wget
          sudo pip3 install meson
          
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            sudo apt-get install -y g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64
          fi
          
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
            wget https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz -O toolchain.tar.xz
            sudo tar -C /opt -xJf toolchain.tar.xz
            echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
          fi

      - name: Clone VKD3D-Proton
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          ref: v3.0b
          submodules: recursive
          fetch-depth: 0
          path: src

      - name: Apply Performance & RAM Patches
        run: |
          cd src
          sed -i 's/device->use_batch_submission = true/device->use_batch_submission = false/g' libs/vkd3d/command.c || true
          sed -i 's/device->enable_strict_barriers = true/device->enable_strict_barriers = false/g' libs/vkd3d/resource.c || true
          
          cat > patch.py << 'PYEOF'
          import re, os
          def patch(path, patches):
              if not os.path.exists(path): return
              with open(path, "r") as f: c = f.read()
              orig = c
              for p, r in patches: c = re.sub(p, r, c)
              if c != orig: open(path, "w").write(c)

          mem_fix = [
              (r'(SharedSystemMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>32ULL * 1024 * 1024 * 1024;'),
              (r'(DedicatedVideoMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>1ULL * 1024 * 1024 * 1024;'),
          ]
          dev_patches = [
              (r'(data->HighestShaderModel\s*=\s*)[^;]+;', r'\g<1>D3D_SHADER_MODEL_6_8;'),
              (r'(MaxSupportedFeatureLevel\s*=\s*)[^;]+;', r'\g<1>D3D_FEATURE_LEVEL_12_2;'),
              (r'(D3D12SDKVersion\s*=\s*)[^;]+;', r'\g<1>618;'),
              (r'(options16\.GPUUploadHeapSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options21\.WorkGraphsTier\s*=\s*)[^;]+;', r'\g<1>D3D12_WORK_GRAPHS_TIER_1_0;'),
          ]
          patch("libs/vkd3d/device.c", mem_fix + dev_patches)
          PYEOF
          python3 patch.py

      - name: Build
        run: |
          cd src
          
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
            cat > cross-arm64ec.txt << 'EOF'
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'arm64ec-w64-mingw32-strip'
          widl = 'arm64ec-w64-mingw32-widl'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          fi
          
          meson setup build --cross-file ${{ matrix.cross_file }} --buildtype release \
            -Dc_args="-O3 -flto" -Dcpp_args="-O3 -flto"
          ninja -C build

      - name: Package
        run: |
          mkdir -p pkg/system32
          cp src/build/libs/d3d12/d3d12.dll pkg/system32/
          cp src/build/libs/d3d12core/d3d12core.dll pkg/system32/
          
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
             # VKD3D-Proton build usually separates 32-bit builds, here we assume 
             # you want the 64-bit DLLs. For full Winlator support, x86_64 container 
             # needs 32-bit DLLs too, but building them requires a separate 32-bit job.
             # We will package what we have now (64-bit).
             echo "Packaging x86_64"
          fi
          
          tar -I zstd -cf vkd3d-proton-${{ matrix.arch }}.wcp -C pkg .

      - uses: actions/upload-artifact@v4
        with:
          name: vkd3d-${{ matrix.arch }}
          path: vkd3d-proton-${{ matrix.arch }}.wcp

  build_dxvk:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            cross_file: build-win64.txt
          - arch: arm64ec
            cross_file: cross-arm64ec.txt
    steps:
      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git ninja-build python3 glslang-tools zstd wget
          sudo pip3 install meson
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
             sudo apt-get install -y g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64
          fi
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
             wget https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz -O toolchain.tar.xz
             sudo tar -C /opt -xJf toolchain.tar.xz
             echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
          fi

      - name: Clone DXVK
        uses: actions/checkout@v4
        with:
          repository: doitsujin/dxvk
          ref: v2.4
          submodules: recursive
          path: src

      - name: Build
        run: |
          cd src
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
             cat > cross-arm64ec.txt << 'EOF'
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'arm64ec-w64-mingw32-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
          fi
          
          meson setup build --cross-file ${{ matrix.cross_file }} --buildtype release --prefix $(pwd)/dist
          ninja -C build install

      - name: Package
        run: |
          mkdir -p pkg/system32
          cp src/dist/bin/d3d11.dll pkg/system32/
          cp src/dist/bin/dxgi.dll pkg/system32/
          tar -I zstd -cf dxvk-${{ matrix.arch }}.wcp -C pkg .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-${{ matrix.arch }}
          path: dxvk-${{ matrix.arch }}.wcp
