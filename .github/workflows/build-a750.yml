name: Turnip Adreno A750

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-a750:
    runs-on: ubuntu-24.04

    env:
      ANDROID_API: "34"
      NDK_VERSION: "r27d"
      MESA_SHADER_CACHE_MAX_SIZE: "2147483648"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ninja-build \
            pkg-config \
            python3-pip \
            python3-mako \
            meson \
            glslang-tools \
            spirv-tools \
            flex \
            bison \
            unzip \
            curl

      - name: Download Android NDK
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-${NDK_VERSION}" >> "$GITHUB_ENV"

      - name: Clone Mesa
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          git rev-parse --short HEAD > ../MESA_COMMIT

      - name: Create missing patch file
        run: |
          echo "檢查補丁文件目錄結構"
          echo "當前目錄: $(pwd)"
          
          # 檢查目錄結構
          if [ ! -d "patches" ]; then
            echo "創建 patches 目錄"
            mkdir -p patches
          fi
          
          if [ ! -d "patches/a750" ]; then
            echo "創建 patches/a750 目錄"
            mkdir -p patches/a750
          fi
          
          echo "檢查補丁文件是否存在"
          if [ ! -f "patches/a750/0006-shader-cache-expand.patch" ]; then
            echo "創建補丁文件"
            cat > patches/a750/0006-shader-cache-expand.patch << 'EOF'
From 8c2a4e9c0b3d1a4c2f6e8b7a9d12f3456789abcd Mon Sep 17 00:00:00 2001
From: MesaTurnipDriver <dev@mesa.local>
Date: Sun, 4 Jan 2026 18:00:00 +0000
Subject: [PATCH] util/disk_cache: increase default shader cache size on Android

On high-RAM Android devices (12GB+), the default shader cache size
is too small for modern DX12 titles running through VKD3D-Proton.

Increase the Android default to 2GB while still respecting
MESA_SHADER_CACHE_MAX_SIZE if explicitly set.

---
 src/util/disk_cache.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/util/disk_cache.c b/src/util/disk_cache.c
index 1f2a3b4c5d6..7a8b9c0d1e2 100644
--- a/src/util/disk_cache.c
+++ b/src/util/disk_cache.c
@@ -84,7 +84,13 @@ static uint64_t
 disk_cache_get_max_size(void)
 {
    const char *env = getenv("MESA_SHADER_CACHE_MAX_SIZE");
-   uint64_t max_size = env ? strtoull(env, NULL, 10) : (uint64_t)1 << 30;
+   uint64_t max_size;
+
+   if (env && env[0] != '\0') {
+      max_size = strtoull(env, NULL, 10);
+   } else {
+      max_size = (uint64_t)2 << 30;
+   }

    return max_size;
 }
-- 
2.43.0
EOF
            echo "補丁文件已創建"
            echo "顯示補丁文件內容:"
            cat patches/a750/0006-shader-cache-expand.patch
          else
            echo "補丁文件已存在"
            echo "顯示補丁文件內容:"
            cat patches/a750/0006-shader-cache-expand.patch
          fi

      - name: Apply A750 patches
        run: |
          echo "開始應用補丁"
          echo "當前工作目錄: $(pwd)"
          echo "檢查補丁文件狀態"
          
          # 確保補丁文件存在
          if [ ! -f "patches/a750/0006-shader-cache-expand.patch" ]; then
            echo "錯誤: 補丁文件不存在"
            exit 1
          fi
          
          echo "補丁文件存在"
          echo "補丁文件大小: $(stat -c%s patches/a750/0006-shader-cache-expand.patch) 字節"
          
          echo "進入 Mesa 原始碼目錄"
          cd mesa
          
          echo "測試補丁應用"
          if git apply --check ../patches/a750/0006-shader-cache-expand.patch; then
            echo "補丁檢查通過, 開始應用"
            git apply ../patches/a750/0006-shader-cache-expand.patch
            echo "補丁應用完成"
          else
            echo "補丁檢查失敗, 分析問題"
            
            # 獲取當前文件內容
            FILE_PATH="src/util/disk_cache.c"
            if [ -f "$FILE_PATH" ]; then
              echo "查找目標代碼位置"
              
              # 檢查原始代碼是否存在
              if grep -q "uint64_t max_size = env ? strtoull(env, NULL, 10) : (uint64_t)1 << 30;" "$FILE_PATH"; then
                echo "找到目標代碼, 進行手動修改"
                
                # 創建備份
                cp "$FILE_PATH" "${FILE_PATH}.backup"
                
                # 執行替換
                sed -i 's/uint64_t max_size = env ? strtoull(env, NULL, 10) : (uint64_t)1 << 30;/uint64_t max_size;\n\n   if (env && env[0] != '\''\\0'\'') {\n      max_size = strtoull(env, NULL, 10);\n   } else {\n      max_size = (uint64_t)2 << 30;\n   }/' "$FILE_PATH"
                
                # 驗證修改
                if [ $? -eq 0 ]; then
                  echo "手動修改完成"
                  echo "修改後內容預覽:"
                  sed -n '84,95p' "$FILE_PATH"
                else
                  echo "手動修改失敗"
                  exit 1
                fi
              else
                echo "目標代碼不存在, 檢查文件版本"
                echo "文件內容預覽 (行 80-90):"
                sed -n '80,90p' "$FILE_PATH"
                exit 1
              fi
            else
              echo "錯誤: 文件 $FILE_PATH 不存在"
              exit 1
            fi
          fi

      - name: Create Android cross file
        run: |
          cat > android-aarch64.txt << EOF
          [binaries]
          c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang'
          cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang++'
          ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

      - name: Build Turnip driver
        run: |
          set -e
          cd mesa

          meson setup build-android \
            --cross-file ../android-aarch64.txt \
            -Dplatforms=android \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers= \
            -Dbuildtype=release \
            -Db_lto=true \
            -Dstrip=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled

          ninja -C build-android

          mkdir -p ../out
          cp build-android/src/freedreno/vulkan/libvulkan_freedreno.so \
            ../out/vulkan.ad07xx.so

      - name: Package driver
        run: |
          set -e
          cp meta/meta-a750.json out/meta.json
          cd out
          zip -9 turnip-adreno-a750.zip vulkan.ad07xx.so meta.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: a750-${{ github.run_number }}
          name: Turnip Adreno A750
          files: out/turnip-adreno-a750.zip
