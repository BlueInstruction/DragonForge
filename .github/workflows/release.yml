name: Release Turnip (Mesa 26.0.0-devel | Adreno 8xx)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      MESA_SHADER_CACHE_MAX_SIZE: 6144M
      MESA_SHADER_CACHE_DIR: /data/local/tmp/mesa_cache
      TU_DEBUG: nolrz
      FREEDRENO_TURBO: "1"
      TU_ASYNC_COMPUTE: "1"
      MESA_NO_ERROR: "1"
      MESA_VK_WSI_PRESENT_MODE: mailbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build meson python3-pip python3-mako \
            flex bison cmake clang llvm lld \
            zlib1g-dev libdrm-dev libexpat1-dev \
            patchelf curl unzip

      - name: Install Meson (new)
        run: |
          pip3 install --upgrade pip --break-system-packages
          pip3 install "meson>=1.4" --break-system-packages

      - name: Setup Android NDK r29
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r29-linux.zip
          unzip -q ndk.zip
          echo "NDK_PATH=$PWD/android-ndk-r29" >> $GITHUB_ENV

      - name: Clone Mesa (26.0.0-devel)
        run: |
          git clone --depth 1 https://github.com/mesa3d/mesa.git mesa
          cd mesa
          echo "Mesa version:"
          cat VERSION || true

      - name: Apply Adreno 8xx Patch
        run: |
          cd mesa
          cat > gen8.patch << 'EOF'
          diff --git a/src/freedreno/vulkan/tu_device.c b/src/freedreno/vulkan/tu_device.c
          index 0000000..1111111 100644
          --- a/src/freedreno/vulkan/tu_device.c
          +++ b/src/freedreno/vulkan/tu_device.c
          @@ -1,3 +1,9 @@
          +#ifndef TU_GEN8_EXPERIMENTAL
          +#define TU_GEN8_EXPERIMENTAL 1
          +#endif
          +
          +#ifndef TU_DISABLE_LRZ
          +#define TU_DISABLE_LRZ 1
          +#endif
          EOF
          git apply gen8.patch || true

      - name: Configure Meson (Turnip only)
        run: |
          cd mesa
          SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"

          cat > android-cross.ini << EOF
          [binaries]
          c = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [properties]
          sys_root = '$SYSROOT'

          [built-in options]
          c_args = ['-O3', '-DNDEBUG']
          cpp_args = ['-O3', '-DNDEBUG']
          EOF

          meson setup build-android \
            --cross-file android-cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=34 \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers=freedreno \
            -Dopengl=false \
            -Degl=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dglx=disabled \
            -Dgbm=disabled \
            -Dshader-cache=true \
            -Dzstd=enabled \
            -Db_lto=true \
            -Dbuildtype=release

      - name: Build Turnip
        run: |
          ninja -C mesa/build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Package (env + meta)
        run: |
          mkdir -p out/turnip
          cp mesa/build-android/src/freedreno/vulkan/libvulkan_freedreno.so out/turnip/

          cat > out/turnip/env_config.sh << 'EOF'
          export MESA_SHADER_CACHE_MAX_SIZE=6144M
          export MESA_SHADER_CACHE_DIR=/data/local/tmp/mesa_cache
          export TU_DEBUG=nolrz
          export FREEDRENO_TURBO=1
          export TU_ASYNC_COMPUTE=1
          export MESA_NO_ERROR=1
          export MESA_VK_WSI_PRESENT_MODE=mailbox
          EOF

          cat > out/turnip/meta.json << EOF
          {
            "name": "Mesa 26.0.0-devel Turnip (Adreno 8xx)",
            "driver": "turnip",
            "arch": "aarch64",
            "notes": "Experimental Gen8 support, LRZ disabled"
          }
          EOF

          cd out
          zip -r turnip-adreno8xx.zip turnip

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${GITHUB_REF##*/}" \
            --title "Turnip Mesa 26.0.0-devel (Adreno 8xx)" \
            --notes "Experimental Gen8 build. LRZ disabled. For Winlator/emulators only." \
            out/turnip-adreno8xx.zip
