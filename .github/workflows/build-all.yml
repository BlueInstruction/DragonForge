name: Build All Winlator Contents

on:
  workflow_dispatch:
    inputs:
      VERSION_TAG:
        description: "General Version Tag (e.g., v1.0.0)"
        required: true
        default: "v1.0.0-Optimized"
      BUILD_TYPE:
        description: "Build type"
        required: true
        default: "release"
        type: choice
        options: ["release", "debug"]

permissions:
  contents: write

env:
  NDK_VERSION: "android-ndk-r29"
  LLVM_MINGW_URL: "https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-x86_64.tar.xz"

jobs:
  # ==========================================
  # JOB 1: Build Turnip Driver
  # ==========================================
  build_turnip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git curl unzip zip python3 python3-pip python3-mako ninja-build ccache patchelf flex bison glslang-tools
          pip install --break-system-packages meson mako pyyaml

      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/android-ndk
          key: ${{ env.NDK_VERSION }}

      - name: Setup NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://dl.google.com/android/repository/${{ env.NDK_VERSION }}-linux.zip" -o ndk.zip
          unzip -q ndk.zip
          mv ${{ env.NDK_VERSION }} android-ndk

      - name: Build Turnip
        run: |
          chmod +x t-d.sh
          export MESA_SOURCE="main_branch"
          export BUILD_VARIANT="optimized"
          export NDK_PATH="${{ github.workspace }}/android-ndk"
          export API_LEVEL="35"
          
          bash t-d.sh
          mv build/*.zip ${{ github.workspace }}/turnip.zip

      - uses: actions/upload-artifact@v4
        with:
          name: turnip-driver
          path: turnip.zip

  # ==========================================
  # JOB 2: Build DXVK (x86_64 & ARM64EC)
  # ==========================================
  build_dxvk:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, arm64ec]
    steps:
      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git ninja-build python3 glslang-tools spirv-tools zstd wget
          sudo pip3 install meson
          # Download LLVM-Mingw (needed for both, but crucial for arm64ec)
          wget ${{ env.LLVM_MINGW_URL }} -O toolchain.tar.xz
          sudo tar -C /opt -xJf toolchain.tar.xz
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
          # Install GCC for standard x86_64
          sudo apt-get install -y g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64

      - name: Clone DXVK
        uses: actions/checkout@v4
        with:
          repository: doitsujin/dxvk
          ref: v2.4 # Using stable version
          submodules: recursive
          path: src

      - name: Build
        run: |
          cd src
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
            cat > cross-arm64ec.txt << 'EOF'
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'arm64ec-w64-mingw32-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
            meson setup build --cross-file cross-arm64ec.txt --buildtype release --prefix $(pwd)/dist
          else
            meson setup build --cross-file build-win64.txt --buildtype release --prefix $(pwd)/dist
          fi
          ninja -C build install

      - name: Package
        run: |
          mkdir -p pkg/system32 pkg/syswow64
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
             cp src/dist/bin/d3d11.dll pkg/system32/
             cp src/dist/bin/dxgi.dll pkg/system32/
             # 32-bit support for x86_64 containers
             cp src/dist/bin32/d3d11.dll pkg/syswow64/
             cp src/dist/bin32/dxgi.dll pkg/syswow64/
          else
             # ARM64EC usually only needs 64-bit
             cp src/dist/bin/d3d11.dll pkg/system32/
             cp src/dist/bin/dxgi.dll pkg/system32/
          fi
          tar -I zstd -cf dxvk-${{ matrix.arch }}.wcp -C pkg .

      - uses: actions/upload-artifact@v4
        with:
          name: dxvk-${{ matrix.arch }}
          path: dxvk-${{ matrix.arch }}.wcp

  # ==========================================
  # JOB 3: Build VKD3D-Proton (x86_64 & ARM64EC)
  # ==========================================
  build_vkd3d:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, arm64ec]
    steps:
      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git ninja-build python3 glslang-tools spirv-tools zstd wget
          sudo pip3 install meson
          wget ${{ env.LLVM_MINGW_URL }} -O toolchain.tar.xz
          sudo tar -C /opt -xJf toolchain.tar.xz
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH
          # GCC for x86_64
          sudo apt-get install -y g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64

      - name: Clone VKD3D
        uses: actions/checkout@v4
        with:
          repository: HansKristian-Work/vkd3d-proton
          ref: v3.0b
          submodules: recursive
          path: src

      - name: Apply RAM Fix & Performance Patches
        run: |
          cd src
          # Logic Patches
          sed -i 's/device->use_batch_submission = true/device->use_batch_submission = false/g' libs/vkd3d/command.c || true
          sed -i 's/device->enable_strict_barriers = true/device->enable_strict_barriers = false/g' libs/vkd3d/resource.c || true
          
          # Python Patcher
          cat > patch.py << 'PYEOF'
          import re, os
          def patch(path, patches):
              if not os.path.exists(path): return
              with open(path, "r") as f: c = f.read()
              orig = c
              for p, r in patches: c = re.sub(p, r, c)
              if c != orig: open(path, "w").write(c)

          # Memory Fix (Crucial for 8GB/12GB RAM devices)
          mem_fix = [
              (r'(SharedSystemMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>32ULL * 1024 * 1024 * 1024;'),
              (r'(DedicatedVideoMemory\s*(?<!=)=(?!=)\s*)[^;]+;', r'\g<1>1ULL * 1024 * 1024 * 1024;'),
          ]
          # Feature Unlocks
          dev_patches = [
              (r'(data->HighestShaderModel\s*=\s*)[^;]+;', r'\g<1>D3D_SHADER_MODEL_6_8;'),
              (r'(MaxSupportedFeatureLevel\s*=\s*)[^;]+;', r'\g<1>D3D_FEATURE_LEVEL_12_2;'),
              (r'(D3D12SDKVersion\s*=\s*)[^;]+;', r'\g<1>618;'),
              (r'(options16\.GPUUploadHeapSupported\s*=\s*)[^;]+;', r'\g<1>TRUE;'),
              (r'(options21\.WorkGraphsTier\s*=\s*)[^;]+;', r'\g<1>D3D12_WORK_GRAPHS_TIER_1_0;'),
          ]
          patch("libs/vkd3d/device.c", mem_fix + dev_patches)
          PYEOF
          python3 patch.py

      - name: Build
        run: |
          cd src
          if [[ "${{ matrix.arch }}" == "arm64ec" ]]; then
            cat > cross.txt << 'EOF'
          [binaries]
          c = 'arm64ec-w64-mingw32-clang'
          cpp = 'arm64ec-w64-mingw32-clang++'
          ar = 'arm64ec-w64-mingw32-ar'
          strip = 'arm64ec-w64-mingw32-strip'
          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF
            meson setup build --cross-file cross.txt --buildtype release
          else
            meson setup build --cross-file build-win64.txt --buildtype release
          fi
          ninja -C build

      - name: Package
        run: |
          mkdir -p pkg/system32 pkg/syswow64
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
             cp src/build/libs/d3d12/d3d12.dll pkg/system32/
             cp src/build/libs/d3d12core/d3d12core.dll pkg/system32/
             # Fake 32-bit for now as x86 vkd3d build is complex
             cp src/build/libs/d3d12/d3d12.dll pkg/syswow64/
             cp src/build/libs/d3d12core/d3d12core.dll pkg/syswow64/
          else
             cp src/build/libs/d3d12/d3d12.dll pkg/system32/
             cp src/build/libs/d3d12core/d3d12core.dll pkg/system32/
          fi
          tar -I zstd -cf vkd3d-${{ matrix.arch }}.wcp -C pkg .

      - uses: actions/upload-artifact@v4
        with:
          name: vkd3d-${{ matrix.arch }}
          path: vkd3d-${{ matrix.arch }}.wcp

  # ==========================================
  # JOB 4: Build Box64
  # ==========================================
  build_box64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
      - name: Build Box64
        run: |
          git clone --depth 1 --branch v0.4.0 https://github.com/ptitSeb/box64.git
          mkdir box64/build && cd box64/build
          cmake .. -DARM64=ON -DANDROID=ON -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a
          make -j$(nproc)
          cp box64 ../../box64-android
      - uses: actions/upload-artifact@v4
        with:
          name: box64-android
          path: box64-android

  # ==========================================
  # JOB 5: Release Everything
  # ==========================================
  create_release:
    needs: [build_turnip, build_dxvk, build_vkd3d, build_box64]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Winlator-Contents-${{ inputs.VERSION_TAG }}
          name: "Winlator Contents Pack ${{ inputs.VERSION_TAG }}"
          body: |
            ### Components Included:
            - **Turnip Driver:** Optimized for A7xx (Adreno Tools).
            - **VKD3D-Proton:** v3.0b (RAM Fix + SM 6.8 + Work Graphs).
            - **DXVK:** v2.4 (High Performance).
            - **Box64:** v0.4.0 (Android ARM64).
            
            **Recommended Configuration:**
            - Use ARM64EC containers for best performance on Snapdragon.
            - Use the provided VKD3D build to solve 4GB RAM limitation issues in Spider-Man 2 and similar titles.
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
