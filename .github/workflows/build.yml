name: Build Mesa Turnip Ultimate v25.3.3

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  MESA_VERSION: "25.3.3"
  ANDROID_API: 34
  SHADER_CACHE_GPU: "2048M"
  SHADER_CACHE_GAME: "4096M"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build meson python3-pip python3-mako flex bison glslang-tools spirv-tools patchelf curl unzip git lld clang libdrm-dev libelf-dev libexpat1-dev libpng-dev libxcb-present-dev libxshmfence-dev libxrandr-dev libwayland-dev wayland-protocols jq
          pip3 install --user --upgrade meson mako
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download Android NDK r29
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r29-linux.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r29" >> $GITHUB_ENV

      - name: Create Android cross file
        run: |
          cat > android-aarch64 << EOF
[binaries]
c = "\$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang"
cpp = "\$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang++"
ar = "\$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
strip = "\$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
pkgconfig = "/usr/bin/pkg-config"

[host_machine]
system = "android"
cpu_family = "aarch64"
cpu = "armv8"
endian = "little"

[properties]
c_args = ["-march=armv8.5-a","-mtune=cortex-x4","-O3","-fno-plt"]
cpp_args = ["-march=armv8.5-a","-mtune=cortex-x4","-O3","-fno-plt"]
EOF

      - name: Clone Mesa 25.3.3
        run: |
          git clone --depth 1 --branch mesa-${MESA_VERSION} https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          MESA_COMMIT=$(git rev-parse --short HEAD)
          echo "MESA_COMMIT=$MESA_COMMIT" >> $GITHUB_ENV

      - name: Apply patches & env overrides
        run: |
          cd mesa
          TARGET_FILE="src/freedreno/vulkan/tu_device.cc"
          if [ -f "$TARGET_FILE" ]; then
            sed -i '/\*pApiVersion = TU_API_VERSION;/a \
if (!getenv("FD_DEV_FEATURES")) { setenv("FD_DEV_FEATURES","enable_tp_ubwc_flag_hint=1",1); } \
if (!getenv("MESA_SHADER_CACHE_MAX_SIZE")) { setenv("MESA_SHADER_CACHE_MAX_SIZE","'"$SHADER_CACHE_GPU"'",1); } \
if (!getenv("TU_DEBUG")) { setenv("TU_DEBUG","force_unaligned_device_local,shader_precompile",1); }' "$TARGET_FILE"
          fi
          curl -L -o prefer_sysmem.patch https://raw.githubusercontent.com/K11MCH1/AdrenoToolsDrivers/main/patches/prefer_sysmem.patch
          git apply prefer_sysmem.patch || true

      - name: Configure Mesa
        run: |
          cd mesa
          meson setup build-android \
            --cross-file ../android-aarch64 \
            -Dplatforms=android \
            -Dplatform-sdk-version=${ANDROID_API} \
            -Dvulkan-drivers=turnip \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers=turnip \
            -Dbuildtype=release \
            -Db_lto=true \
            -Dstrip=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dopengl=false

      - name: Build Turnip
        run: |
          cd mesa
          ninja -C build-android
          cp build-android/src/freedreno/vulkan/libvulkan_freedreno.so ../vulkan.ad07xx.so

      - name: Create meta.json
        run: |
          cat > meta.json << EOF
{
  "schemaVersion": 1,
  "name": "Mesa Turnip",
  "vendor": "Mesa",
  "driver": "turnip",
  "minApi": 29,
  "libraryName": "vulkan.ad07xx.so",
  "features": [
    "Environment overrides (FD_DEV_FEATURES, TU_DEBUG, MESA_SHADER_CACHE_MAX_SIZE)",
    "Optimized build flags for Adreno 750 (-O3, -march=armv8.5-a, -mtune=cortex-x4)",
    "Cross-compilation support for Android API 29",
    "Packaged vulkan.ad07xx.so with metadata"
  ]
}
EOF

      - name: Package
        run: |
          zip -9 mesa-v25.3.3-android.zip vulkan.ad07xx.so meta.json

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mesa-25.3.3-${MESA_COMMIT}
          name: Mesa Turnip v25.3.3 Android
          files: mesa-v25.3.3-android.zip
