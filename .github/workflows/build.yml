name: Build Turnip v26.0.0-devel9

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Build Variant'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - regular
          - gmem
          - sysmem
          - autotuner
          - nolrz
          - nolrz-gmem
          - performance
      enable_lrz:
        description: 'Enable LRZ (Global)'
        required: false
        default: true
        type: boolean
      apply_patches:
        description: 'Apply A7xx Performance Patches'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

env:
  # ÿ£Mesa commit
  MESA_COMMIT: "main"
  MESA_VERSION: "26.0.0"
  BUILD_TAG: "devel9"
  NDK_VERSION: "r29"
  API_LEVEL: "31"
  VULKAN_VERSION: "1.4.335"

jobs:
  # Job commit
  get-mesa-info:
    runs-on: ubuntu-24.04
    outputs:
      commit_sha: ${{ steps.mesa.outputs.sha }}
      commit_date: ${{ steps.mesa.outputs.date }}
      vulkan_version: ${{ steps.mesa.outputs.vulkan }}
    steps:
      - name: Get Latest Mesa Info
        id: mesa
        run: |
          # Clone Mesa and get latest info
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          SHA=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=short)
          
          # Get Vulkan version from meson.build
          VK_VERSION=$(grep -oP "vk_api_version\s*=\s*'\K[^']+" meson.build 2>/dev/null || echo "1.4.335")
          
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "vulkan=$VK_VERSION" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "  Mesa Latest Info"
          echo "=========================================="
          echo "Commit: $SHA"
          echo "Date: $DATE"
          echo "Vulkan: $VK_VERSION"
          echo "=========================================="

  build-turnip:
    needs: get-mesa-info
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # === Standard Variants ===
          - variant: regular
            suffix: ""
            c_args: ""
            tu_debug: ""
            description: "Standard build"
          
          - variant: gmem
            suffix: "_Gmem"
            c_args: "-DTU_DEFAULT_GMEM=1"
            tu_debug: "gmem"
            description: "Force GMEM rendering"
          
          - variant: sysmem
            suffix: "_Sysmem"
            c_args: "-DTU_DEFAULT_SYSMEM=1"
            tu_debug: "sysmem"
            description: "Force System Memory rendering"
          
          - variant: autotuner
            suffix: "_Autotuner"
            c_args: "-DTU_AUTOTUNER=1"
            tu_debug: ""
            description: "Auto GMEM/Sysmem selection"
          
          # === NoLRZ Variants ===
          - variant: nolrz
            suffix: "_NoLRZ"
            c_args: "-DTU_DISABLE_LRZ=1"
            tu_debug: "nolrz"
            description: "Disabled LRZ (fixes graphical glitches)"
          
          - variant: nolrz-gmem
            suffix: "_NoLRZ_Gmem"
            c_args: "-DTU_DISABLE_LRZ=1 -DTU_DEFAULT_GMEM=1"
            tu_debug: "nolrz,gmem"
            description: "NoLRZ + GMEM (best compatibility)"
          
          # === Performance Variant ===
          - variant: performance
            suffix: "_Performance"
            c_args: "-DTU_DEFAULT_GMEM=1 -DTU_AGGRESSIVE_PREFETCH=1 -DNDEBUG"
            tu_debug: "gmem"
            description: "Maximum performance (experimental)"

    steps:
      - name: Check Build Selection
        id: check
        run: |
          SELECTED="${{ github.event.inputs.build_variant }}"
          CURRENT="${{ matrix.variant }}"
          if [ "$SELECTED" = "all" ] || [ "$SELECTED" = "$CURRENT" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Install Dependencies
        if: steps.check.outputs.run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip python3-mako \
            flex bison patchelf curl unzip clang lld llvm cmake pkg-config

      - name: Build Glslang
        if: steps.check.outputs.run == 'true'
        run: |
          git clone --depth 1 --branch 15.1.0 https://github.com/KhronosGroup/glslang.git
          cmake -S glslang -B glslang/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/glslang \
            -DENABLE_OPT=0
          cmake --build glslang/build -j$(nproc)
          cmake --install glslang/build
          echo "$HOME/glslang/bin" >> $GITHUB_PATH

      - name: Setup Meson
        if: steps.check.outputs.run == 'true'
        run: pip3 install --upgrade meson

      - name: Setup NDK
        if: steps.check.outputs.run == 'true'
        run: |
          curl -sL -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip"
          unzip -q ndk.zip
          echo "NDK=$PWD/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Clone Mesa (Latest)
        if: steps.check.outputs.run == 'true'
        run: |
          echo "=========================================="
          echo "  Cloning Latest Mesa"
          echo "=========================================="
          git clone --depth 100 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Date: $(git log -1 --format=%cd --date=short)"
          echo "=========================================="

      - name: Download Patches
        if: steps.check.outputs.run == 'true' && github.event.inputs.apply_patches == 'true'
        run: |
          mkdir -p patches
          cd patches
          
          echo "=========================================="
          echo "  Downloading A7xx Performance Patches"
          echo "=========================================="
          
          # 1. droidvm patches
          echo "[1/3] Cloning droidvm patches..."
          git clone --depth 1 https://github.com/droidvm/mesa-freedreno-patchs.git droidvm 2>/dev/null || true
          
          # 2. K11MCH1 patches
          echo "[2/3] Fetching K11MCH1 patches..."
          curl -sL -o k11mch1-turnip.patch \
            "https://raw.githubusercontent.com/K11MCH1/AdrenoToolsDrivers/main/patches/turnip-a7xx.patch" 2>/dev/null || true
          
          # 3. airidosas252 patches
          echo "[3/3] Fetching airidosas252 patches..."
          git clone --depth 1 https://github.com/airidosas252/Turnip-builds-for-Adreno-7xx.git airidosas 2>/dev/null || true
          
          echo "=========================================="
          find . -name "*.patch" -type f 2>/dev/null | head -20 || true
          echo "=========================================="

      - name: Apply Patches
        if: steps.check.outputs.run == 'true' && github.event.inputs.apply_patches == 'true'
        continue-on-error: true
        run: |
          cd mesa
          
          echo "=========================================="
          echo "  Applying Patches"
          echo "=========================================="
          
          APPLIED=0
          SKIPPED=0
          
          apply_patch() {
            local patch="$1"
            local name=$(basename "$patch")
            
            [ ! -f "$patch" ] || [ ! -s "$patch" ] && return
            head -1 "$patch" | grep -q "<!DOCTYPE\|<html\|404" && return
            
            if git apply --check "$patch" 2>/dev/null; then
              git apply "$patch" 2>/dev/null && echo "‚úì Applied: $name" && APPLIED=$((APPLIED + 1)) && return
            fi
            
            if git apply --check --3way "$patch" 2>/dev/null; then
              git apply --3way "$patch" 2>/dev/null && echo "‚úì Applied (3-way): $name" && APPLIED=$((APPLIED + 1)) && return
            fi
            
            echo "‚úó Skipped: $name"
            SKIPPED=$((SKIPPED + 1))
          }
          
          # Apply patches
          for patch in ../patches/*.patch; do
            [ -f "$patch" ] && apply_patch "$patch"
          done
          
          # droidvm patches
          if [ -d "../patches/droidvm" ]; then
            LATEST_DIR=$(ls -d ../patches/droidvm/freedreno-kgsl-patchs-for-* 2>/dev/null | sort -V | tail -1)
            [ -d "$LATEST_DIR" ] && for patch in "$LATEST_DIR"/*.patch; do
              [ -f "$patch" ] && apply_patch "$patch"
            done
          fi
          
          echo "=========================================="
          echo "  Summary: $APPLIED applied, $SKIPPED skipped"
          echo "=========================================="

      - name: Configure
        if: steps.check.outputs.run == 'true'
        run: |
          cd mesa
          
          cat > cross.ini << EOF
          [binaries]
          c = ['aarch64-linux-android${{ env.API_LEVEL }}-clang']
          cpp = ['aarch64-linux-android${{ env.API_LEVEL }}-clang++']
          ar = ['llvm-ar']
          strip = ['llvm-strip']
          ld = ['lld']
          
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          # Performance flags based on variant
          VARIANT="${{ matrix.variant }}"
          if [ "$VARIANT" = "performance" ]; then
            PERF_FLAGS="-O3 -flto=full -ffast-math -fno-signed-zeros -fno-trapping-math -fomit-frame-pointer -march=armv8-a+simd"
          else
            PERF_FLAGS="-O3 -flto=thin -ffast-math -fno-signed-zeros -fno-trapping-math -fomit-frame-pointer"
          fi
          
          meson setup build --cross-file cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.API_LEVEL }} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Dgallium-drivers= \
            -Dopengl=false \
            -Degl=disabled \
            -Dshader-cache=disabled \
            -Db_lto=true \
            -Dc_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 ${{ matrix.c_args }}" \
            -Dcpp_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 ${{ matrix.c_args }}" \
            -Dc_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz -flto=thin" \
            -Dcpp_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz -flto=thin"

      - name: Build
        if: steps.check.outputs.run == 'true'
        run: |
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          ninja -C mesa/build src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Package
        if: steps.check.outputs.run == 'true'
        run: |
          mkdir -p release/out/lib64
          cp mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so release/out/lib64/vulkan.ad07XX.so
          
          # Get actual commit info
          cd mesa
          ACTUAL_COMMIT=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=short)
          cd ..
          
          cat > release/out/meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}",
            "description": "${{ matrix.description }}",
            "author": "mesa",
            "packageVersion": "${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}",
            "vendor": "Mesa",
            "driverVersion": "${{ env.MESA_VERSION }}/vk${{ env.VULKAN_VERSION }}",
            "minApi": ${{ env.API_LEVEL }},
            "libraryName": "vulkan.ad07XX.so",
            "commit": "$ACTUAL_COMMIT",
            "commitDate": "$COMMIT_DATE",
            "tuDebug": "${{ matrix.tu_debug }}"
          }
          EOF
          
          cd release/out && zip -r ../Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}.zip .

      - name: Upload
        if: steps.check.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: turnip-${{ matrix.variant }}
          path: release/Turnip_v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}${{ matrix.suffix }}.zip
          retention-days: 5

  release:
    needs: [get-mesa-info, build-turnip]
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_variant == 'all'
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Checksums
        run: |
          cd dist
          sha256sum *.zip > SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}
          name: "Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}"
          body: |
            ## üöÄ Turnip v${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}
            ### Optimized for Adreno 7xx (725/730/740/750)
            
            | Info | Value |
            |------|-------|
            | Mesa Commit | `${{ needs.get-mesa-info.outputs.commit_sha }}` |
            | Commit Date | ${{ needs.get-mesa-info.outputs.commit_date }} |
            | Vulkan | ${{ needs.get-mesa-info.outputs.vulkan_version }} |
            | NDK | ${{ env.NDK_VERSION }} |
            | API Level | ${{ env.API_LEVEL }} |
            | LTO | ‚úì Enabled |
            
            ---
            
            ## üì¶ Variants Guide
            
            ### Standard Variants
            | Variant | File | Use Case |
            |---------|------|----------|
            | **Regular** | `...${{ env.BUILD_TAG }}.zip` | Default, balanced |
            | **Gmem** | `..._Gmem.zip` | ‚≠ê **Best for Winlator** |
            | **Sysmem** | `..._Sysmem.zip` | Compatibility mode |
            | **Autotuner** | `..._Autotuner.zip` | Auto selection |
            
            ### Compatibility Variants
            | Variant | File | Use Case |
            |---------|------|----------|
            | **NoLRZ** | `..._NoLRZ.zip` | Fixes graphical glitches |
            | **NoLRZ+Gmem** | `..._NoLRZ_Gmem.zip` | ‚≠ê **Best compatibility** |
            
            ### Performance Variant
            | Variant | File | Use Case |
            |---------|------|----------|
            | **Performance** | `..._Performance.zip` | üî• Maximum FPS (experimental) |
            
            ---
            
            ## üéÆ Recommended Settings
            
            ### For Winlator:
            ```
            TU_DEBUG=gmem
            MESA_VK_WSI_PRESENT_MODE=mailbox
            ```
            
            ### For ONE UI devices:
            ```
            FD_DEV_FEATURES=enable_tp_ubwc_flag_hint=1
            ```
            
            ### If you have graphical glitches:
            ```
            TU_DEBUG=nolrz
            ```
            
            ---
            
            ## üéØ Game Recommendations
            
            | Game | Recommended Variant |
            |------|---------------------|
            | Assassin's Creed Origins | Gmem / NoLRZ_Gmem |
            | Forza Horizon 4 | Gmem / Performance |
            | Cyberpunk 2077 | NoLRZ_Gmem |
            | Elden Ring | Gmem |
            | Red Dead Redemption 2 | NoLRZ_Gmem |
            
            ---
            
            ## ‚ö†Ô∏è Troubleshooting
            
            | Problem | Solution |
            |---------|----------|
            | Black screen | Use Sysmem variant |
            | Crashes | Use NoLRZ variant |
            | Low FPS | Use Gmem or Performance |
            | Texture glitches | Use NoLRZ_Gmem |
            
          files: |
            dist/*.zip
            dist/SHA256SUMS.txt
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
