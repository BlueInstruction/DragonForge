name: Advanced Turnip Builder with Auto-Patching

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa branch/tag (default: main)'
        required: false
        default: 'main'
        type: string
      target_device:
        description: 'Target Adreno device'
        required: false
        default: 'adreno-750'
        type: choice
        options:
          - adreno-730
          - adreno-740
          - adreno-750
          - generic-a6xx
          - generic-a7xx
      enable_auto_patches:
        description: 'Enable automatic patch updates'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    outputs:
      mesa_source: ${{ steps.select-source.outputs.selected_source }}
      device_config: ${{ steps.device-config.outputs.config }}
    
    steps:
      - name: Install Prerequisites
        run: sudo apt-get update && sudo apt-get install -y jq curl git

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source
          
      - name: Select Mesa Source
        id: select-source
        run: echo "selected_source=https://gitlab.freedesktop.org/mesa/mesa.git" >> $GITHUB_OUTPUT
          
      - name: Device Config
        id: device-config
        run: |
          DEVICE="${{ github.event.inputs.target_device }}"
          case $DEVICE in
            "adreno-750") CONFIG='{"gpu_id":"750","kmds":["msm","kgsl"],"patches":["gen8-support"]}' ;;
            "adreno-740") CONFIG='{"gpu_id":"740","kmds":["kgsl"],"patches":["gen7-support"]}' ;;
            *) CONFIG='{"gpu_id":"generic","kmds":["kgsl"],"patches":[]}' ;;
          esac
          echo "config=$CONFIG" >> $GITHUB_OUTPUT

      - name: Prepare Patches
        run: |
          # Create a specific directory for the transfer
          mkdir -p ${{ github.workspace }}/transfer_patches
          
          # Force a dummy file so the artifact is NOT empty (prevents download errors)
          touch ${{ github.workspace }}/transfer_patches/.keep_alive
          
          # Copy any repo patches if they exist
          if [ -d "source/patches" ]; then
            cp -r source/patches/* ${{ github.workspace }}/transfer_patches/ 2>/dev/null || true
          fi

      - name: Upload Patches
        uses: actions/upload-artifact@v4
        with:
          name: patches-bundle
          path: ${{ github.workspace }}/transfer_patches/
          retention-days: 1 # Artifacts expire based on settings
          compression-level: 6 # Default compression for best balance

  build-turnip:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download Patches
        uses: actions/download-artifact@v4
        with:
          name: patches-bundle
          path: source/patches/
          
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build python3-pip python3-mako flex bison \
            patchelf curl unzip clang lld llvm libclang-dev pkg-config jq
          pip3 install --break-system-packages --upgrade meson mako
          
      - name: Setup NDK
        run: |
          curl -L -o ndk.zip "https://dl.google.com/android/repository/android-ndk-r26d-linux.zip"
          unzip -q ndk.zip
          echo "NDK_PATH=$PWD/android-ndk-r26d" >> $GITHUB_ENV
          
      - name: Clone and Build
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.mesa_branch }} ${{ needs.setup-environment.outputs.mesa_source }} mesa-source
          cd mesa-source
          
          # Generate Cross File
          cat > android_cross.ini << EOF
          [binaries]
          c = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          ld = 'lld'
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          meson setup build-android --cross-file android_cross.ini -Dplatforms=android -Dvulkan-drivers=freedreno -Dbuildtype=release
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: turnip-driver-${{ github.event.inputs.target_device }}
          path: mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so
