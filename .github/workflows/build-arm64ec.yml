name: Build VKD3D-Proton ARM64EC

on:
  workflow_dispatch:
    inputs:
      VERSION:
        description: "Version (empty = latest)"
        required: false
        default: ""
  workflow_call:
    inputs:
      VERSION:
        type: string
        required: false
        default: ""
    outputs:
      version:
        value: ${{ jobs.build.outputs.version }}
      commit:
        value: ${{ jobs.build.outputs.commit }}
      artifact_name:
        value: ${{ jobs.build.outputs.artifact_name }}

concurrency:
  group: build-arm64ec-${{ github.ref }}-${{ inputs.VERSION || 'latest' }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  LLVM_MINGW_VER: "20250114"
  TOOLCHAIN_DIR: "/opt/llvm-mingw"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      commit: ${{ steps.clone.outputs.COMMIT }}
      artifact_name: ${{ steps.package.outputs.ARTIFACT_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache LLVM MinGW
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: /opt/llvm-mingw
          key: llvm-mingw-${{ env.LLVM_MINGW_VER }}-arm64ec

      - name: Setup Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git meson ninja-build curl jq python3 \
            glslang-tools spirv-tools zstd llvm

      - name: Setup LLVM MinGW
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/mstorsjo/llvm-mingw/releases/download/${{ env.LLVM_MINGW_VER }}/llvm-mingw-${{ env.LLVM_MINGW_VER }}-ucrt-ubuntu-20.04-x86_64.tar.xz" \
            | sudo tar -xJ -C /opt
          sudo mv /opt/llvm-mingw-* ${{ env.TOOLCHAIN_DIR }}

      - name: Configure Path
        run: |
          echo "${{ env.TOOLCHAIN_DIR }}/bin" >> $GITHUB_PATH

      - name: Verify Toolchain
        run: |
          echo "ARM64EC: $(aarch64-w64-mingw32-gcc --version | head -1)"
          echo "i686: $(i686-w64-mingw32-gcc --version | head -1)"
          which widl || echo "widl not found, using llvm-mingw widl"

      - name: Get Version
        id: version
        run: |
          if [[ -n "${{ inputs.VERSION }}" ]]; then
            VER="${{ inputs.VERSION }}"
            [[ "$VER" =~ ^v ]] || VER="v$VER"
          else
            VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r '.tag_name // empty')
            [[ -z "$VER" ]] && VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases | jq -r '.[0].tag_name')
          fi
          echo "TAG=$VER" >> $GITHUB_ENV
          echo "VERSION=${VER#v}" >> $GITHUB_OUTPUT

      - name: Clone Source
        id: clone
        run: |
          git clone --branch ${{ env.TAG }} --depth 1 https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          git submodule update --init --recursive --depth 1 --jobs 4
          COMMIT=$(git rev-parse --short=8 HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV

      - name: Apply Patches
        run: python3 scripts/apply-patches.py src --arch arm64ec --report

      - name: Upload Patch Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: patch-report-arm64ec-${{ steps.version.outputs.VERSION }}-${{ steps.clone.outputs.COMMIT }}
          path: patch-report.txt
          retention-days: 7

      - name: Create Cross Files
        run: |
          cat > arm64ec-cross.txt << 'EOF'
          [binaries]
          c = 'aarch64-w64-mingw32-gcc'
          cpp = 'aarch64-w64-mingw32-g++'
          ar = 'aarch64-w64-mingw32-ar'
          strip = 'llvm-strip'
          windres = 'aarch64-w64-mingw32-windres'
          widl = 'aarch64-w64-mingw32-widl'

          [built-in options]
          c_args = ['-O3', '-DNDEBUG', '-ffast-math', '-fno-strict-aliasing', '-mno-outline-atomics']
          cpp_args = ['-O3', '-DNDEBUG', '-ffast-math', '-fno-strict-aliasing', '-mno-outline-atomics']
          c_link_args = ['-static', '-s']
          cpp_link_args = ['-static', '-s']

          [host_machine]
          system = 'windows'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

          cat > i686-cross.txt << 'EOF'
          [binaries]
          c = 'i686-w64-mingw32-gcc'
          cpp = 'i686-w64-mingw32-g++'
          ar = 'i686-w64-mingw32-ar'
          strip = 'llvm-strip'
          windres = 'i686-w64-mingw32-windres'
          widl = 'i686-w64-mingw32-widl'

          [built-in options]
          c_args = ['-O3', '-DNDEBUG', '-ffast-math', '-fno-strict-aliasing', '-msse', '-msse2']
          cpp_args = ['-O3', '-DNDEBUG', '-ffast-math', '-fno-strict-aliasing', '-msse', '-msse2']
          c_link_args = ['-static', '-s']
          cpp_link_args = ['-static', '-s']

          [host_machine]
          system = 'windows'
          cpu_family = 'x86'
          cpu = 'i686'
          endian = 'little'
          EOF

      - name: Build ARM64EC
        run: |
          cd src
          meson setup build-arm64ec \
            --cross-file ../arm64ec-cross.txt \
            --buildtype release \
            -Denable_tests=false \
            -Denable_extras=false
          ninja -C build-arm64ec -j$(nproc)

      - name: Build i686
        run: |
          cd src
          meson setup build-i686 \
            --cross-file ../i686-cross.txt \
            --buildtype release \
            -Denable_tests=false \
            -Denable_extras=false
          ninja -C build-i686 -j$(nproc)

      - name: Verify Build
        run: |
          for arch in arm64ec i686; do
            for dll in d3d12.dll d3d12core.dll; do
              DLL_PATH=$(find src/build-${arch} -name "$dll" -type f | head -1)
              if [[ -z "$DLL_PATH" || ! -f "$DLL_PATH" ]]; then
                echo "Missing: $dll ($arch)"
                find src/build-${arch} -type f -name "*.dll" || true
                exit 1
              fi
              echo "$dll ($arch): $(stat -c%s "$DLL_PATH") bytes"
            done
          done

      - name: Package
        id: package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          COMMIT="${{ env.COMMIT }}"
          ARTIFACT_NAME="vkd3d-proton-arm64ec-${VERSION}-${COMMIT}"

          mkdir -p pkg/system32 pkg/syswow64

          for dll in d3d12.dll d3d12core.dll; do
            ARM64_DLL=$(find src/build-arm64ec -name "$dll" -type f | head -1)
            I686_DLL=$(find src/build-i686 -name "$dll" -type f | head -1)
            [[ -n "$ARM64_DLL" ]] && cp "$ARM64_DLL" pkg/system32/
            [[ -n "$I686_DLL" ]] && cp "$I686_DLL" pkg/syswow64/
          done

          cd pkg
          sha256sum system32/*.dll syswow64/*.dll > checksums.txt

          cat > profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "VKD3D-Proton ${VERSION} ARM64EC",
            "versionCode": ${{ env.COMMIT_COUNT }},
            "description": "VKD3D-Proton ARM64EC ${VERSION} (${COMMIT})",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF

          tar --zstd -cf "../${ARTIFACT_NAME}.wcp" .
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.ARTIFACT_NAME }}
          path: |
            ${{ steps.package.outputs.ARTIFACT_NAME }}.wcp
            pkg/checksums.txt
          retention-days: 30
